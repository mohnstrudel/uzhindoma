// # Place all the behaviors and hooks related to the matching controller here.
// # All this logic will automatically be available in application.js.
// # You can use CoffeeScript in this file: http://coffeescript.org/




$('dinner').ready(function(){

	$("#standard_order_phone").mask("+7 (999) 999-9999");

	$("#standard_order_phone").on('mousedown', function(){
		$("#standard_order_phone").removeClass('wrong-phone-number');
	});

	$("#create_new_order").on('click', function(e){
		var phone_input = $("#standard_order_phone");
		var phone_value = phone_input.val();
		// console.log("Phone input value is: " + phone_input.length);
		var exists = phone_input.length;

		if (exists != 0) {
			if (phone_value) {
				// console.log("Phone is: " + phone);
				// e.preventDefault();
			}
			else {

				// console.log("No correct phone entered");
				phone_input.addClass("wrong-phone-number");
				console.log("Default prevented for submit button");
				e.preventDefault();
			}
		}
	});

	// Preclick for user - tab 1
	$('#radio1-da-0-0').prop("checked", true);
	$('#radio2-pa-0-0').prop("checked", true);
	// Dessert
	$('#radio9-0').prop("checked", true);

	// Preclick for user - tab 2
	$('#radio1-da-0-1').prop("checked", true);
	$('#radio2-pa-0-1').prop("checked", true);
	// Dessert
	$('#radio9-1').prop("checked", true);

	// Preclick for user - tab 2
	$('#radio1-da-0-2').prop("checked", true);
	$('#radio2-pa-0-2').prop("checked", true);


	$('#dinner-tab-0').click();

	var activeTab = 0;
	
	$('a[data-toggle="tab"]').on('shown.bs.tab', function(e){
        var activeTab = $(e.target).attr('href');
        var tabId = activeTab.split('-')[1];
        activeTab = parseFloat(tabId);
		console.log("Active tab is: " + activeTab);

		recalculate(price, activeTab);
	});

	// Should be changed in the future!
	var basic_price = 2400;
	// end
	var price = extract_price(activeTab);
	price = basic_price;

	recalculate(price, activeTab);
	console.log("Initial price is: " + price);

	// Call all js for tab = 0
	$('.uzhin_rb_persons').on('click', 'input[name=person_amount_0]', function(event){
		recalculate(price, 0);
		// event.stopImmediatePropagation();
	});

	$('.uzhin_rb_menus').on('click', 'input[name=menu_amount_0]', function(event){
		recalculate(price, 0);
	});

	$('.uzhin_rb_dessert').on('click', 'input[name=add_dessert_0]', function(event){
		recalculate(price, 0);
	});

	// Call all js for tab = 1
	$('.uzhin_rb_persons').on('click', 'input[name=person_amount_1]', function(event){
		recalculate(price, 1);
		// event.stopImmediatePropagation();
	});

	$('.uzhin_rb_menus').on('click', 'input[name=menu_amount_1]', function(event){
		recalculate(price, 1);
	});

	$('.uzhin_rb_dessert').on('click', 'input[name=add_dessert_1]', function(event){
		recalculate(price, 1);
	});

	// Call all js for tab = 2
	$('.uzhin_rb_persons').on('click', 'input[name=person_amount_2]', function(event){
		recalculate(price, 2);
		// event.stopImmediatePropagation();
	});

	$('.uzhin_rb_menus').on('click', 'input[name=menu_amount_2]', function(event){
		recalculate(price, 2);
	});

	$('.uzhin_rb_dessert').on('click', 'input[name=add_dessert_2]', function(event){
		recalculate(price, 2);
	});
	
});

var extract_numbers = function (array_as_string){

	if (typeof array_as_string != 'undefined') {
		console.log("array input is: " + array_as_string);
		var splitted_array = array_as_string.split(",");
		var first_part = splitted_array[0];
		var second_part = splitted_array[1];
		var third_part = splitted_array[2];

		first_part = first_part.replace('[','').replace(' ', '');
		first_part = parseFloat(first_part);

		second_part = second_part.replace(']','').replace(' ', '');
		second_part = parseFloat(second_part);
		if (typeof third_part != 'undefined'){
			third_part = third_part.replace(']','').replace(' ', '');
			third_part = parseFloat(third_part);
		}

		return [first_part, second_part, third_part];
	} else {
		console.log("Empty call of 'extract_numbers' function");
	}
}

var recalculate = function (price, tab){
	var end_price;
	end_price = update_price(price, tab);
	end_price = update_menus(end_price, tab);
	end_price = update_dessert(end_price, tab);
	
	display_price(end_price, tab);
}

var update_dessert = function(price, tab){
	console.log("Dessert active tab: " + tab);
	var dessert_amount = $("input[name=add_dessert_" + tab + "]:checked").val();
	dessert_amount = parseFloat(dessert_amount);

	if(isNaN(dessert_amount)) {
		dessert_amount = 0;
	}
	console.log("Original price: "+ price + " and dessert amount: " + dessert_amount);
	return price + dessert_amount;
}

var update_menus = function (price, tab){
	var price_change;
	var menus_amount = get_menus(tab);
	if (typeof menus_amount != 'undefined'){
		
		extracted_numbers = extract_numbers(menus_amount);
		price_change = extracted_numbers[1];
		if (get_amount_of_persons(tab) == 4){
			price_change += extracted_numbers[2];
		}
		return price+price_change;
	} else {
		console.log("Empty call of 'update_menus' function");
	}

}

var get_menus = function (tab){
	var menus_amount = $("input[name=menu_amount_" + tab + "]:checked").val();	
	// console.log(number_price);
	console.log("Menu amount is: " + menus_amount);
	return menus_amount;
}

var extract_price = function (tab){
	var price = $('#uzhin_price_' + tab).text();
	var stripped_price = price.split('.')[0].split(',').join("");
	var number_price = parseFloat(stripped_price);
	console.log("Extracted price is: " + number_price);
	return number_price;
}

var get_persons = function (tab){
	// var person_amount = $('input[name=person_amount]:checked').val();	
	var person_amount = $("input[name=person_amount_" + tab + "]:checked").val();	
	console.log("Person amount is: " + person_amount);
	return person_amount;
}

var get_amount_of_persons = function (tab){
	var person_amount = $("input[name=person_amount_" + tab + "]:checked").val();	
	amount_of_persons = extract_numbers(person_amount)[0];
	return amount_of_persons;
}

var update_price = function(price, tab){
	var price_change;
	var person_amount = get_persons(tab);

	if (typeof person_amount != 'undefined') {
		price_change = extract_numbers(person_amount)[1];

		return price+price_change;
	} else {
		console.log("Empty call of 'update_price' function");
	}

}

var display_price = function(price, tab){
	$('#uzhin_price_'+tab).text(format_price(price));
}

var format_price = function(price){
	var string_price = price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
	string_price = string_price + ".00 ";

	return string_price; 
}